# 启动流程 / Startup Process

本文档介绍如何启动每日打卡 Pro 项目的后端和前端服务。

This document describes how to start the backend and frontend services for Daily Check-in Pro.

---

## 前置要求 / Prerequisites

### 通用 / General
- Node.js >= 18.x
- npm >= 9.x 或 yarn >= 1.22.x
- Git

### 后端 / Backend
- MySQL >= 8.0
- 微信小程序账号（用于获取 AppID 和 Secret）

### 前端 / Frontend
- 微信开发者工具（下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html）

---

## 后端启动 / Backend Startup

### 1. 安装依赖

```bash
cd backend/daily-check-in-api
npm install
```

### 2. 配置环境变量

复制 `.env.example` 并重命名为 `.env`，然后编辑配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填写以下配置：

```env
# 数据库配置（需提前创建数据库）
DATABASE_URL="mysql://root:your_password@localhost:3306/daily_check_in_pro"

# JWT 配置（生产环境请使用强密码）
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
JWT_EXPIRES_IN="7d"

# 微信小程序配置
WECHAT_APPID="your-wechat-appid"
WECHAT_SECRET="your-wechat-secret"

# 服务端口
PORT=3000

# 运行环境
NODE_ENV=development

# CORS 允许的源
CORS_ORIGIN="http://localhost:5173"
```

### 3. 创建数据库

登录 MySQL 并创建数据库：

```bash
mysql -u root -p
```

```sql
CREATE DATABASE daily_check_in_pro CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

### 4. 执行数据库迁移

初始化 Prisma 并生成客户端：

```bash
# 生成 Prisma Client
npx prisma generate

# 执行数据库迁移（创建表结构）
npx prisma migrate dev --name init
```

### 5. 启动开发服务器

```bash
# 开发模式（支持热重载）
npm run start:dev

# 或者直接启动
npm start
```

服务将启动在 `http://localhost:3000`

---

## 前端启动 / Frontend Startup

### 1. 安装依赖

```bash
cd frontend/daily-check-in-app
npm install
```

### 2. 配置环境变量

复制 `.env.example` 并重命名为 `.env`：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
# 后端 API 地址
VITE_API_BASE_URL=http://localhost:3000
```

### 3. 开发模式启动

```bash
npm run dev
```

项目将在浏览器中打开，默认地址为 `http://localhost:5173`

### 4. 打包小程序

```bash
# 构建 H5
npm run build:h5

# 构建 微信小程序
npm run build:mp-weixin
```

### 5. 微信开发者工具预览

1. 打开微信开发者工具
2. 选择「小程序」项目
3. 导入项目目录：`frontend/daily-check-in-app/dist/dev/mp-weixin`
4. 填入你的微信小程序 AppID
5. 预览和调试

---

## 常用命令 / Common Commands

### 后端命令

| 命令 | 说明 |
|------|------|
| `npm run start` | 启动生产环境 |
| `npm run start:dev` | 启动开发环境（热重载） |
| `npm run build` | 构建项目 |
| `npx prisma generate` | 生成 Prisma Client |
| `npx prisma migrate dev` | 执行开发环境迁移 |
| `npx prisma migrate deploy` | 执行生产环境迁移 |
| `npx prisma studio` | 打开 Prisma 数据库管理界面 |

### 前端命令

| 命令 | 说明 |
|------|------|
| `npm run dev` | 启动开发服务器 |
| `npm run build:h5` | 构建 H5 项目 |
| `npm run build:mp-weixin` | 构建微信小程序 |
| `npm run dev:h5` | H5 开发模式 |
| `npm run dev:mp-weixin` | 微信小程序开发模式 |

---

## 常见问题 / Troubleshooting

### 1. 数据库连接失败

**问题**：`Can't reach database server at <host>:<port>`

**解决方案**：
- 检查 MySQL 服务是否启动
- 检查 `.env` 中的数据库配置是否正确
- 确认数据库已创建

### 2. Prisma Client 生成失败

**问题**：`This location is not a valid Prisma schema`

**解决方案**：
- 确保已在 `backend/daily-check-in-api` 目录下
- 检查 `prisma/schema.prisma` 文件是否存在且格式正确
- 运行 `npx prisma validate` 检查 schema

### 3. 微信登录失败

**问题**：`invalid appid`

**解决方案**：
- 确认 `.env` 中的 `WECHAT_APPID` 和 `WECHAT_SECRET` 正确
- 确保小程序已在微信公众平台注册并审核通过

### 4. CORS 跨域错误

**问题**：前端请求后端接口报跨域错误

**解决方案**：
- 检查后端 `.env` 中的 `CORS_ORIGIN` 配置
- 确认前端地址与配置的允许源匹配

### 5. 前端构建失败

**问题**：`VITE failed to resolve import`

**解决方案**：
- 删除 `node_modules` 和 `package-lock.json`
- 重新运行 `npm install`

---

## 端口占用处理 / Port Conflict

如果默认端口被占用，可以修改端口配置：

### 修改后端端口

编辑 `.env` 文件：
```env
PORT=3001
```

### 修改前端代理端口

如果使用开发服务器，终端会自动分配可用端口。如需指定端口：

```bash
npm run dev -- --port 5174
```

---

## 开发工具推荐 / Recommended Tools

- **IDE**: VS Code + Volar 插件
- **API 测试**: Postman 或 Apifox
- **数据库**: Navicat 或 DBeaver
- **版本控制**: Git + GitHub/GitLab
- **代码格式化**: Prettier + ESLint
