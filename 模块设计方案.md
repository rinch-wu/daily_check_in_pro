# 模块设计方案

## 项目概述
「每日打卡Pro」微信小程序 - 基于uni-app + NestJS + MySQL + Prisma的模块化架构设计

## 一、整体架构设计

### 1.1 系统分层架构
```
┌─────────────────────────────────────────────────────────┐
│                      表现层                               │
│                 (uni-app 前端小程序)                      │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                      接口层                               │
│                   (RESTful API / WebSocket)               │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                      业务层                               │
│          (用户模块 | 打卡模块 | 社交模块 | 激励模块)          │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                      数据层                               │
│                    (Prisma ORM)                          │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    数据存储层                             │
│                     (MySQL 数据库)                        │
└─────────────────────────────────────────────────────────┘
```

### 1.2 模块划分原则
- **高内聚**：每个模块内部功能紧密相关
- **低耦合**：模块间通过接口通信，减少依赖
- **可扩展**：支持模块独立升级和扩展
- **可维护**：清晰的模块边界和职责划分

## 二、核心业务模块设计

### 2.1 用户模块 (User Module)

#### 职责范围
- 用户注册与登录（微信授权登录）
- 用户信息管理
- 用户数据统计
- 用户设置管理

#### 前端组件结构
```
src/modules/user/
├── pages/                    # 用户相关页面
│   ├── auth/                # 授权登录页
│   ├── profile/             # 个人资料页
│   └── settings/            # 设置页
├── components/              # 组件
│   ├── UserInfoCard.vue     # 用户信息卡片
│   ├── AvatarUpload.vue     # 头像上传
│   └── SettingsForm.vue     # 设置表单
├── stores/                  # 状态管理
│   └── userStore.ts
└── api/                     # API接口
    └── userApi.ts
```

#### 后端模块结构
```
src/modules/user/
├── user.module.ts           # 模块定义
├── user.controller.ts       # 控制器
├── user.service.ts          # 业务逻辑
├── dto/                     # 数据传输对象
│   ├── login.dto.ts
│   ├── update-profile.dto.ts
│   └── update-settings.dto.ts
└── entities/                # 实体
    └── user.entity.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 微信登录 | POST | /api/user/login | 微信授权登录 |
| 获取用户信息 | GET | /api/user/profile | 获取当前用户信息 |
| 更新用户信息 | PUT | /api/user/profile | 更新用户资料 |
| 更新设置 | PUT | /api/user/settings | 更新用户设置 |

---

### 2.2 打卡模块 (CheckIn Module)

#### 职责范围
- 打卡项管理（创建、编辑、删除）
- 打卡记录管理
- 补签功能
- 打卡提醒
- 打卡统计与日历展示

#### 前端组件结构
```
src/modules/checkin/
├── pages/                    # 打卡相关页面
│   ├── home/                # 首页（打卡项列表）
│   ├── create/              # 创建打卡项
│   ├── detail/              # 打卡详情
│   └── records/             # 打卡记录
├── components/              # 组件
│   ├── CheckInCard.vue      # 打卡卡片
│   ├── CheckInButton.vue    # 打卡按钮
│   ├── CalendarView.vue     # 日历视图
│   └── StatsChart.vue       # 统计图表
├── stores/                  # 状态管理
│   └── checkinStore.ts
└── api/                     # API接口
    └── checkinApi.ts
```

#### 后端模块结构
```
src/modules/checkin/
├── checkin.module.ts        # 模块定义
├── checkin.controller.ts    # 控制器
├── checkin.service.ts       # 业务逻辑
├── dto/                     # 数据传输对象
│   ├── create-item.dto.ts
│   ├── update-item.dto.ts
│   ├── submit-checkin.dto.ts
│   └── makeup-checkin.dto.ts
├── entities/                # 实体
│   ├── checkin-item.entity.ts
│   └── checkin-record.entity.ts
└── guards/                  # 守卫
    └── checkin-ownership.guard.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建打卡项 | POST | /api/checkin/items | 创建新的打卡项 |
| 获取打卡项列表 | GET | /api/checkin/items | 获取用户所有打卡项 |
| 更新打卡项 | PUT | /api/checkin/items/:id | 更新打卡项信息 |
| 删除打卡项 | DELETE | /api/checkin/items/:id | 删除打卡项 |
| 提交打卡 | POST | /api/checkin/records | 打卡提交 |
| 补签 | POST | /api/checkin/records/makeup | 用积分补签 |
| 获取打卡记录 | GET | /api/checkin/records | 获取打卡记录列表 |
| 打卡统计 | GET | /api/checkin/stats | 获取打卡统计数据 |

---

### 2.3 社交模块 (Social Module)

#### 职责范围
- 好友组队功能
- 队伍管理
- 好友排行榜
- 打卡圈动态发布与互动
- 点赞、评论功能

#### 前端组件结构
```
src/modules/social/
├── pages/                    # 社交相关页面
│   ├── community/           # 打卡圈
│   ├── team/                # 组队页
│   ├── team-create/         # 创建队伍
│   ├── team-detail/         # 队伍详情
│   └── leaderboard/         # 排行榜
├── components/              # 组件
│   ├── PostCard.vue         # 动态卡片
│   ├── TeamCard.vue         # 队伍卡片
│   ├── LeaderboardItem.vue  # 排行榜项
│   └── CommentList.vue      # 评论列表
├── stores/                  # 状态管理
│   ├── socialStore.ts
│   └── teamStore.ts
└── api/                     # API接口
    ├── socialApi.ts
    └── teamApi.ts
```

#### 后端模块结构
```
src/modules/social/
├── social.module.ts         # 模块定义
├── social.controller.ts     # 控制器
├── social.service.ts        # 业务逻辑
├── dto/                     # 数据传输对象
│   ├── create-post.dto.ts
│   ├── create-team.dto.ts
│   └── join-team.dto.ts
├── entities/                # 实体
│   ├── team.entity.ts
│   ├── team-member.entity.ts
│   ├── post.entity.ts
│   ├── comment.entity.ts
│   └── like.entity.ts
└── services/                # 子服务
    ├── team.service.ts
    ├── post.service.ts
    └── leaderboard.service.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建队伍 | POST | /api/social/teams | 创建组队打卡 |
| 加入队伍 | POST | /api/social/teams/:id/join | 加入队伍 |
| 获取队伍列表 | GET | /api/social/teams | 获取队伍列表 |
| 队伍详情 | GET | /api/social/teams/:id | 获取队伍详情 |
| 发布动态 | POST | /api/social/posts | 发布打卡圈动态 |
| 获取动态列表 | GET | /api/social/posts | 获取动态列表 |
| 点赞 | POST | /api/social/posts/:id/like | 点赞动态 |
| 取消点赞 | DELETE | /api/social/posts/:id/like | 取消点赞 |
| 评论 | POST | /api/social/posts/:id/comments | 评论动态 |
| 获取排行榜 | GET | /api/social/leaderboard | 获取好友排行榜 |

---

### 2.4 激励模块 (Incentive Module)

#### 职责范围
- 积分管理与积分计算
- 积分兑换
- 勋章系统
- 成就系统
- 阶梯挑战活动

#### 前端组件结构
```
src/modules/incentive/
├── pages/                    # 激励相关页面
│   ├── points/              # 积分中心
│   ├── exchange/            # 兑换商城
│   ├── medals/              # 勋章墙
│   └── challenge/           # 挑战活动
├── components/              # 组件
│   ├── PointsCard.vue       # 积分卡片
│   ├── MedalIcon.vue        # 勋章图标
│   ├── ExchangeItem.vue     # 兑换项
│   └── ChallengeCard.vue    # 挑战卡片
├── stores/                  # 状态管理
│   ├── pointsStore.ts
│   └── medalStore.ts
└── api/                     # API接口
    ├── pointsApi.ts
    └── medalApi.ts
```

#### 后端模块结构
```
src/modules/incentive/
├── incentive.module.ts      # 模块定义
├── incentive.controller.ts  # 控制器
├── incentive.service.ts     # 业务逻辑
├── dto/                     # 数据传输对象
│   ├── exchange.dto.ts
│   └── join-challenge.dto.ts
├── entities/                # 实体
│   ├── points-record.entity.ts
│   ├── medal.entity.ts
│   ├── user-medal.entity.ts
│   ├── achievement.entity.ts
│   └── challenge.entity.ts
└── services/                # 子服务
    ├── points.service.ts
    ├── medal.service.ts
    └── challenge.service.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取积分余额 | GET | /api/incentive/points | 获取用户积分 |
| 获取积分记录 | GET | /api/incentive/points/records | 获取积分明细 |
| 积分兑换 | POST | /api/incentive/exchange | 积分兑换物品 |
| 获取勋章 | GET | /api/incentive/medals | 获取用户勋章 |
| 获取挑战列表 | GET | /api/incentive/challenges | 获取挑战活动 |
| 参与挑战 | POST | /api/incentive/challenges/:id/join | 报名挑战 |
| 挑战进度 | GET | /api/incentive/challenges/:id/progress | 查看挑战进度 |

---

### 2.5 通知模块 (Notification Module)

#### 职责范围
- 打卡提醒通知
- 团队提醒
- 活动通知
- 系统通知

#### 前端组件结构
```
src/modules/notification/
├── pages/                    # 通知相关页面
│   └── list/                # 通知列表
├── components/              # 组件
│   └── NotificationItem.vue # 通知项
├── stores/                  # 状态管理
│   └── notificationStore.ts
└── api/                     # API接口
    └── notificationApi.ts
```

#### 后端模块结构
```
src/modules/notification/
├── notification.module.ts   # 模块定义
├── notification.controller.ts
├── notification.service.ts
├── dto/
│   └── send-notification.dto.ts
└── entities/
    └── notification.entity.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取通知列表 | GET | /api/notification | 获取用户通知 |
| 标记已读 | PUT | /api/notification/:id/read | 标记通知已读 |
| 清空通知 | DELETE | /api/notification | 清空所有通知 |

---

### 2.6 统计分析模块 (Analytics Module)

#### 职责范围
- 用户数据统计
- 打卡趋势分析
- 完成率计算
- 数据报告生成

#### 前端组件结构
```
src/modules/analytics/
├── pages/                    # 统计相关页面
│   └── dashboard/           # 数据看板
├── components/              # 组件
│   ├── StatCard.vue         # 统计卡片
│   ├── TrendChart.vue       # 趋势图表
│   └── ReportPreview.vue    # 报告预览
├── stores/                  # 状态管理
│   └── analyticsStore.ts
└── api/                     # API接口
    └── analyticsApi.ts
```

#### 后端模块结构
```
src/modules/analytics/
├── analytics.module.ts      # 模块定义
├── analytics.controller.ts
├── analytics.service.ts
└── dto/
    └── get-stats.dto.ts
```

#### 核心接口
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取用户统计 | GET | /api/analytics/user | 获取用户整体统计 |
| 获取打卡趋势 | GET | /api/analytics/trend | 获取打卡趋势 |
| 生成月度报告 | GET | /api/analytics/report | 生成月度报告 |

## 三、共享模块设计

### 3.1 公共组件模块
```
src/common/components/
├── Button/
├── Input/
├── Modal/
├── Toast/
├── Loading/
└── Empty/
```

### 3.2 工具模块
```
src/common/utils/
├── date.ts                  # 日期处理
├── storage.ts               # 本地存储
├── request.ts               # 请求封装
├── validation.ts            # 数据验证
└── format.ts                # 格式化工具
```

### 3.3 状态管理模块
```
src/common/stores/
├── appStore.ts              # 应用全局状态
└── loadingStore.ts          # 加载状态
```

## 四、数据库模型设计

### 4.1 用户相关表

```prisma
model User {
  id          String   @id @default(cuid())
  openid      String   @unique  // 微信openid
  unionid     String?  @unique  // 微信unionid
  nickname    String
  avatar      String
  points      Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  checkinItems  CheckInItem[]
  checkinRecords CheckInRecord[]
  teams         Team[]
  teamMembers   TeamMember[]
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  pointsRecords PointsRecord[]
  userMedals    UserMedal[]
  notifications Notification[]
}
```

### 4.2 打卡相关表

```prisma
model CheckInItem {
  id           String       @id @default(cuid())
  userId       String
  name         String
  type         String       // count/timing/proof
  dailyTarget  String?      // 每日目标
  cycle        String       // daily/weekly/custom
  reminderTime String?      // 提醒时间
  reminderText String?      // 提醒文案
  sortOrder    Int          @default(0)
  isHidden     Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user    User            @relation(fields: [userId], references: [id])
  records CheckInRecord[]

  @@index([userId])
}

model CheckInRecord {
  id            String   @id @default(cuid())
  userId        String
  itemId        String
  date          DateTime @default(now())
  note          String?  // 打卡备注
  status        String   // normal/makeup
  makeupCost    Int?     // 补签积分消耗
  createdAt     DateTime @default(now())

  user User            @relation(fields: [userId], references: [id])
  item CheckInItem     @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId, date])
  @@index([userId])
  @@index([itemId])
}
```

### 4.3 社交相关表

```prisma
model Team {
  id          String   @id @default(cuid())
  userId      String   // 队长ID
  name        String
  description String?
  maxMembers  Int      @default(5)
  target      String?  // 团队目标
  status      String   @default('active')  // active/disbanded
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  captain User     @relation(fields: [userId], references: [id])
  members  TeamMember[]

  @@index([userId])
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     String   @default('member')  // captain/member
  joinedAt DateTime @default(now())

  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([userId])
}

model Post {
  id        String    @id @default(cuid())
  userId    String
  itemId    String?
  content   String
  images    String?   // 图片URL（逗号分隔）
  tags      String?   // 标签（学习/健身/生活）
  likes     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user     User        @relation(fields: [userId], references: [id])
  comments Comment[]
  likes    Like[]

  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  content   String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])
}

model Like {
  id        String    @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime  @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}
```

### 4.4 激励相关表

```prisma
model PointsRecord {
  id          String   @id @default(cuid())
  userId      String
  type        String   // earn/deduct/exchange
  amount      Int
  reason      String
  relatedId   String?  // 关联ID
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Medal {
  id       String @id @default(cuid())
  name     String
  description String
  icon     String
  condition String // 获得条件（连续打卡7天等）
  rarity   String // common/rare/legendary
}

model UserMedal {
  id        String   @id @default(cuid())
  userId    String
  medalId   String
  earnedAt  DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])

  @@unique([userId, medalId])
}

model Achievement {
  id        String   @id @default(cuid())
  userId    String
  name      String
  description String
  reachedAt DateTime @default(now())

  @@unique([userId, name])
}

model Challenge {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String   // weekly/monthly
  rewardPoints Int
  rewardMedal  String?
  entryPoints Int      @default(0)
  startDate   DateTime
  endDate     DateTime
  status      String   @default('upcoming')  // upcoming/ongoing/ended
  createdAt   DateTime @default(now())

  participants Int @default(0)
}
```

### 4.5 通知相关表

```prisma
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // reminder/system/team/challenge
  title     String
  content   String
  isRead    Boolean  @default(false)
  relatedId String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}
```

## 五、前端路由设计

### 5.1 主页面路由
```
├── pages/
│   ├── index/              # Tab1 - 首页
│   │   └── index.vue
│   ├── community/          # Tab2 - 打卡圈
│   │   └── community.vue
│   ├── team/               # Tab3 - 组队
│   │   └── team.vue
│   └── mine/               # Tab4 - 我的
│       └── mine.vue
```

### 5.2 子页面路由（分包）
```
├── pages_sub/
│   ├── auth/
│   │   └── login.vue      # 登录页
│   ├── checkin/
│   │   ├── create.vue     # 创建打卡项
│   │   ├── detail.vue     # 打卡详情
│   │   └── records.vue    # 打卡记录
│   ├── social/
│   │   ├── team-create.vue
│   │   ├── team-detail.vue
│   │   └── leaderboard.vue
│   ├── incentive/
│   │   ├── points.vue     # 积分中心
│   │   ├── exchange.vue   # 兑换商城
│   │   ├── medals.vue     # 勋章墙
│   │   └── challenge.vue  # 挑战活动
│   └── analytics/
│       └── dashboard.vue  # 数据看板
```

## 六、API接口规范

### 6.1 统一响应格式
```typescript
// 成功响应
{
  "code": 0,
  "message": "success",
  "data": { }
}

// 错误响应
{
  "code": 400,
  "message": "error message",
  "data": null
}
```

### 6.2 状态码定义
| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

### 6.3 认证方式
- 微信小程序登录：使用微信小程序 `login` 接口获取 `code`，后端换取 `openid` 和 `session_key`
- 请求鉴权：使用 JWT Token 进行认证，Token 存储在请求 Header `Authorization: Bearer {token}`

## 七、模块间通信设计

### 7.1 事件总线（前端）
```typescript
// src/common/eventBus.ts
import { ref } from 'vue'

type EventHandler = (...args: any[]) => void

class EventBus {
  private events: Map<string, EventHandler[]> = new Map()

  on(event: string, handler: EventHandler) {
    if (!this.events.has(event)) {
      this.events.set(event, [])
    }
    this.events.get(event)!.push(handler)
  }

  emit(event: string, ...args: any[]) {
    const handlers = this.events.get(event)
    if (handlers) {
      handlers.forEach(handler => handler(...args))
    }
  }

  off(event: string, handler: EventHandler) {
    const handlers = this.events.get(event)
    if (handlers) {
      const index = handlers.indexOf(handler)
      if (index > -1) {
        handlers.splice(index, 1)
      }
    }
  }
}

export const eventBus = new EventBus()

// 使用示例
eventBus.on('checkin:success', (data) => {
  console.log('打卡成功', data)
})

eventBus.emit('checkin:success', { itemId: 'xxx' })
```

### 7.2 模块间服务调用（后端）
```typescript
// 使用 NestJS 的依赖注入进行模块间通信
// src/modules/checkin/checkin.service.ts
@Injectable()
export class CheckInService {
  constructor(
    @Inject(forwardRef(() => IncentiveService))
    private incentiveService: IncentiveService,
  ) {}

  async submitCheckin(userId: string, itemId: string) {
    // 打卡逻辑
    const record = await this.createRecord(userId, itemId)

    // 触发积分奖励
    await this.incentiveService.addPoints(userId, 5, 'checkin')

    return record
  }
}
```

## 八、异常处理设计

### 8.1 前端异常处理
```typescript
// src/common/utils/request.ts
import { eventBus } from './eventBus'

uni.request({
  url: apiUrl,
  method: 'POST',
  data: requestData,
  success: (res) => {
    if (res.data.code === 0) {
      resolve(res.data.data)
    } else {
      // 业务错误处理
      eventBus.emit('error', res.data.message)
      reject(res.data.message)
    }
  },
  fail: (err) => {
    // 网络错误处理
    eventBus.emit('error', '网络请求失败')
    reject(err)
  }
})
```

### 8.2 后端异常处理
```typescript
// src/common/filters/http-exception.filter.ts
@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp()
    const response = ctx.getResponse()
    const status = exception.getStatus()
    const message = exception.message

    response.status(status).json({
      code: status,
      message: message,
      data: null,
    })
  }
}
```

## 九、性能优化策略

### 9.1 前端优化
1. **分包加载**：非核心页面放入分包，减少主包体积
2. **数据缓存**：使用 Pinia 持久化插件缓存用户数据
3. **图片懒加载**：动态列表中的图片使用懒加载
4. **组件复用**：封装通用组件，减少重复代码

### 9.2 后端优化
1. **数据库索引**：为常用查询字段添加索引
2. **查询优化**：使用 Prisma 的 `select` 和 `include` 精确控制查询字段
3. **缓存策略**：热点数据使用 Redis 缓存
4. **批量操作**：聚合查询使用批量操作减少数据库往返

## 十、安全设计

### 10.1 数据安全
- 用户密码加密存储（bcrypt）
- 敏感数据加密传输（HTTPS）
- 用户数据权限校验

### 10.2 接口安全
- JWT Token 认证
- 请求频率限制（Rate Limiting）
- SQL注入防护（Prisma 自动防护）

### 10.3 隐私保护
- 用户数据脱敏展示
- 遵守微信小程序隐私政策
- 不收集无关用户信息

## 十一、扩展性设计

### 11.1 插件化设计
支持未来扩展新功能模块，如：
- 数据导出插件
- 第三方登录插件
- 支付集成插件

### 11.2 配置化设计
关键功能参数支持配置：
- 积分规则配置
- 勋章条件配置
- 挑战活动配置

## 十二、部署架构

### 12.1 前端部署
```
微信小程序平台
  ↓
小程序包上传
  ↓
微信审核通过
  ↓
线上发布
```

### 12.2 后端部署
```
Nginx (反向代理)
  ↓
NestJS 应用 (Docker容器)
  ↓
Prisma ORM
  ↓
MySQL 数据库
```

## 十三、监控与日志

### 13.1 前端监控
- 错误日志收集
- 性能监控
- 用户行为分析

### 13.2 后端监控
- 请求日志记录
- 错误追踪
- 性能指标监控

---

## 总结

本模块设计方案基于 PRD 需求，采用模块化架构设计，实现了以下目标：

1. **清晰的模块划分**：按功能域划分为 6 个核心业务模块
2. **低耦合高内聚**：模块间通过接口通信，依赖注入解耦
3. **可扩展可维护**：支持模块独立开发和升级
4. **类型安全**：全 TypeScript 开发，Prisma 提供类型安全
5. **性能优化**：前端分包加载、后端缓存策略
6. **安全可靠**：完善的认证授权和异常处理机制

该设计为后续开发提供了清晰的架构指导，确保项目的可维护性和可扩展性。